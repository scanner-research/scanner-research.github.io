
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />

<title>scannerpy.op - Scanner</title>


    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
<link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/default.min.css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-133298183-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-133298183-1');
</script>


  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Scanner 0.2.22 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
<div class="container">
  <div id="navbar" class="navbar-default">
    <div class="row">
      <div class="col-md-4 col-sm-12">
        <a class="navbar-brand" href="../../index.html"><span><img src="../../_static/scanner_logo.png"></span>
        </a>
      </div>
      <div class="col-md-4 offset-md-4 col-sm-12">
        <div class="btn-group">
          <a href="../../guide.html"><button type="button" class="btn btn-light">Guide</button></a>
          <a href="../../api.html"><button type="button" class="btn btn-light">API</button></a>
          <a href="https://github.com/scanner-research/scanner"><button type="button" class="btn btn-light">Github</button></a>
          <a href="../../publications.html"><button type="button" class="btn btn-light">Publications</button></a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
      <div class="bs-sidenav">
        <div class="bs-sidenav-inner">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    </div>
    <div class="col-md-9">
      <div class="content">
        
  <h1>Source code for scannerpy.op</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">types</span> <span class="k">as</span> <span class="nn">pytypes</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">collections</span>

<span class="kn">from</span> <span class="nn">scannerpy.common</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scannerpy.protobufs</span> <span class="kn">import</span> <span class="n">python_to_proto</span><span class="p">,</span> <span class="n">protobufs</span><span class="p">,</span> <span class="n">analyze_proto</span>
<span class="kn">from</span> <span class="nn">scannerpy</span> <span class="kn">import</span> <span class="n">types</span> <span class="k">as</span> <span class="n">scannertypes</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">signature</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>


<div class="viewcode-block" id="SliceList"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.SliceList">[docs]</a><span class="k">class</span> <span class="nc">SliceList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List of per-stream arguments to each slice of an op.&quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="collect_per_stream_args"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.collect_per_stream_args">[docs]</a><span class="k">def</span> <span class="nf">collect_per_stream_args</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">protobuf_name</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="n">stream_arg_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">analyze_proto</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">protobufs</span><span class="p">,</span> <span class="n">protobuf_name</span><span class="p">))</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">stream_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">stream_arg_names</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stream_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
            <span class="s2">&quot;Op `</span><span class="si">{}</span><span class="s2">` received no per-stream arguments. Options: </span><span class="si">{}</span><span class="s2">&quot;</span> \
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stream_args</span><span class="p">)))</span>

    <span class="n">N</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stream_args</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">job_args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">python_to_proto</span><span class="p">(</span><span class="n">protobuf_name</span><span class="p">,</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stream_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">})</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">job_args</span></div>


<div class="viewcode-block" id="OpColumn"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn">[docs]</a><span class="k">class</span> <span class="nc">OpColumn</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span> <span class="o">=</span> <span class="n">sc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">op</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_col</span> <span class="o">=</span> <span class="n">col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">typ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encode_options</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="n">protobufs</span><span class="o">.</span><span class="n">Video</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_encode_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;codec&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="OpColumn.compress"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn.compress">[docs]</a>    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codec</span><span class="o">=</span><span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_is_video</span><span class="p">()</span>
        <span class="n">codecs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;video&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_video</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_default</span><span class="p">,</span>
            <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lossless</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">codec</span> <span class="ow">in</span> <span class="n">codecs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">codecs</span><span class="p">[</span><span class="n">codec</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Compression codec </span><span class="si">{}</span><span class="s1"> not currently &#39;</span>
                                   <span class="s1">&#39;supported. Available codecs are: </span><span class="si">{}</span><span class="s1">.&#39;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span></div>

<div class="viewcode-block" id="OpColumn.compress_video"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn.compress_video">[docs]</a>    <span class="k">def</span> <span class="nf">compress_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quality</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">bitrate</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keyframe_distance</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_is_video</span><span class="p">()</span>
        <span class="n">encode_options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;codec&#39;</span><span class="p">:</span> <span class="s1">&#39;h264&#39;</span><span class="p">,</span>
            <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="n">quality</span><span class="p">,</span>
            <span class="s1">&#39;bitrate&#39;</span><span class="p">:</span> <span class="n">bitrate</span><span class="p">,</span>
            <span class="s1">&#39;keyframe_distance&#39;</span><span class="p">:</span> <span class="n">keyframe_distance</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_compressed_column</span><span class="p">(</span><span class="n">encode_options</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpColumn.lossless"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn.lossless">[docs]</a>    <span class="k">def</span> <span class="nf">lossless</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_is_video</span><span class="p">()</span>
        <span class="n">encode_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;codec&#39;</span><span class="p">:</span> <span class="s1">&#39;raw&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_compressed_column</span><span class="p">(</span><span class="n">encode_options</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpColumn.compress_default"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn.compress_default">[docs]</a>    <span class="k">def</span> <span class="nf">compress_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_is_video</span><span class="p">()</span>
        <span class="n">encode_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;codec&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_compressed_column</span><span class="p">(</span><span class="n">encode_options</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_assert_is_video</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">!=</span> <span class="n">protobufs</span><span class="o">.</span><span class="n">Video</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Compression only supported for sequences of&#39;</span>
                                   <span class="s1">&#39;type &quot;video&quot;. Sequence </span><span class="si">{}</span><span class="s1"> type is </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">,</span>
                                       <span class="n">protobufs</span><span class="o">.</span><span class="n">ColumnType</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_new_compressed_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encode_options</span><span class="p">):</span>
        <span class="n">new_col</span> <span class="o">=</span> <span class="n">OpColumn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">)</span>
        <span class="n">new_col</span><span class="o">.</span><span class="n">_encode_options</span> <span class="o">=</span> <span class="n">encode_options</span>
        <span class="k">return</span> <span class="n">new_col</span></div>


<span class="n">MODULE_REGISTRY</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>


<div class="viewcode-block" id="register_module"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.register_module">[docs]</a><span class="k">def</span> <span class="nf">register_module</span><span class="p">(</span><span class="n">so_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">proto_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">MODULE_REGISTRY</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">so_path</span><span class="p">,</span> <span class="n">proto_path</span><span class="p">))</span></div>


<div class="viewcode-block" id="check_modules"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.check_modules">[docs]</a><span class="k">def</span> <span class="nf">check_modules</span><span class="p">(</span><span class="n">sc</span><span class="p">):</span>
    <span class="n">unregistered_modules</span> <span class="o">=</span> <span class="n">MODULE_REGISTRY</span> <span class="o">-</span> <span class="n">sc</span><span class="o">.</span><span class="n">_modules</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">unregistered_modules</span><span class="p">:</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">load_op</span><span class="p">(</span><span class="o">*</span><span class="n">module</span><span class="p">)</span></div>


<span class="n">PYTHON_OP_REGISTRY</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="OpGenerator"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpGenerator">[docs]</a><span class="k">class</span> <span class="nc">OpGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates Op instances to define a computation.</span>

<span class="sd">    When a particular op is requested from the generator, e.g.</span>
<span class="sd">    `sc.ops.Histogram`, the generator does a dynamic lookup for the</span>
<span class="sd">    op in a C++ registry.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span> <span class="o">=</span> <span class="n">sc</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">check_modules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="p">)</span>

        <span class="n">stream_params</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">orig_name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># Check python registry for Op</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">PYTHON_OP_REGISTRY</span><span class="p">:</span>
            <span class="n">py_op_info</span> <span class="o">=</span> <span class="n">PYTHON_OP_REGISTRY</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">stream_params</span> <span class="o">=</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;stream_params&#39;</span><span class="p">]</span>
            <span class="c1"># If Op has not been registered yet, register it</span>
            <span class="n">pseudo_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;registration_id&#39;</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">pseudo_name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_python_ops</span><span class="p">:</span>
                <span class="n">devices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;device_type&#39;</span><span class="p">]:</span>
                    <span class="n">devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;device_type&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;device_sets&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;device_sets&#39;</span><span class="p">]:</span>
                        <span class="n">devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">register_op</span><span class="p">(</span>
                    <span class="n">pseudo_name</span><span class="p">,</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;input_columns&#39;</span><span class="p">],</span>
                    <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;output_columns&#39;</span><span class="p">],</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;variadic_inputs&#39;</span><span class="p">],</span>
                    <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;stencil&#39;</span><span class="p">],</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;unbounded_state&#39;</span><span class="p">],</span>
                    <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;bounded_state&#39;</span><span class="p">],</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;proto_path&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">register_python_kernel</span><span class="p">(</span><span class="n">pseudo_name</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
                                                    <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">],</span>
                                                    <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">])</span>

        <span class="c1"># This will raise an exception if the op does not exist.</span>
        <span class="n">op_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_get_op_info</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">orig_name</span> <span class="ow">in</span> <span class="n">PYTHON_OP_REGISTRY</span> <span class="ow">and</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">op_info</span><span class="o">.</span><span class="n">stream_protobuf_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">stream_proto</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">protobufs</span><span class="p">,</span> <span class="n">op_info</span><span class="o">.</span><span class="n">stream_protobuf_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">proto_field_name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">analyze_proto</span><span class="p">(</span><span class="n">stream_proto</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">stream_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proto_field_name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">make_op</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">op_info</span><span class="o">.</span><span class="n">variadic_inputs</span><span class="p">:</span>
                <span class="n">inputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">op_info</span><span class="o">.</span><span class="n">input_columns</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                            <span class="s1">&#39;Op </span><span class="si">{}</span><span class="s1"> required sequence </span><span class="si">{}</span><span class="s1"> as input&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">orig_name</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="n">device</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;device&#39;</span><span class="p">,</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bounded_state</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;bounded_state&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">stencil</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;stencil&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;extra&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stream_params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">stream_args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">stream_params</span>
                               <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stream_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                           <span class="s2">&quot;No arguments provided to op `</span><span class="si">{}</span><span class="s2">` for stream parameters.&quot;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orig_name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">stream_args</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                            <span class="s2">&quot;The argument `</span><span class="si">{}</span><span class="s2">` to op `</span><span class="si">{}</span><span class="s2">` is a stream config argument and must be a list.&quot;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">orig_name</span><span class="p">))</span>
                <span class="n">example_list</span> <span class="o">=</span> <span class="n">stream_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">example_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">example_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SliceList</span><span class="p">):</span>
                    <span class="n">stream_args</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[</span><span class="n">SliceList</span><span class="p">([</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">])</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="ow">in</span> <span class="n">stream_args</span><span class="p">]</span>
                <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stream_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">orig_name</span> <span class="ow">in</span> <span class="n">PYTHON_OP_REGISTRY</span><span class="p">:</span>
                    <span class="n">stream_args</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">SliceList</span><span class="p">([</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stream_args</span><span class="p">})</span>
                                   <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">)])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stream_args</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">SliceList</span><span class="p">([</span><span class="n">python_to_proto</span><span class="p">(</span><span class="n">op_info</span><span class="o">.</span><span class="n">stream_protobuf_name</span><span class="p">,</span>
                                                   <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stream_args</span><span class="p">})</span>
                                  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">)])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
                    <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stream_args</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">op</span> <span class="o">=</span> <span class="n">Op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">bounded_state</span><span class="p">,</span>
                    <span class="n">stencil</span><span class="p">,</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">args</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">stream_args</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_op</span></div>


<div class="viewcode-block" id="Op"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.Op">[docs]</a><span class="k">class</span> <span class="nc">Op</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">sc</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">,</span>
                 <span class="n">inputs</span><span class="p">,</span>
                 <span class="n">device</span><span class="p">,</span>
                 <span class="n">batch</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">warmup</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">stencil</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">args</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">extra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">stream_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span> <span class="o">=</span> <span class="n">sc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warmup</span> <span class="o">=</span> <span class="n">warmup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stencil</span> <span class="o">=</span> <span class="n">stencil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span> <span class="o">=</span> <span class="n">extra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_job_args</span> <span class="o">=</span> <span class="n">stream_args</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Space&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Sample&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Slice&#39;</span>
                <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Unslice&#39;</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OpColumn</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">_col</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">_type</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_get_output_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">OpColumn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span> <span class="o">=</span> <span class="n">outputs</span>

<div class="viewcode-block" id="Op.inputs"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.Op.inputs">[docs]</a>    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span></div>

<div class="viewcode-block" id="Op.outputs"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.Op.outputs">[docs]</a>    <span class="k">def</span> <span class="nf">outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Op.to_proto"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.Op.to_proto">[docs]</a>    <span class="k">def</span> <span class="nf">to_proto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">protobufs</span><span class="o">.</span><span class="n">Op</span><span class="p">()</span>
        <span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
        <span class="n">e</span><span class="o">.</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">to_proto</span><span class="p">(</span><span class="n">protobufs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">stencil</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stencil</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span>
        <span class="n">e</span><span class="o">.</span><span class="n">warmup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warmup</span>

        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Input&quot;</span><span class="p">:</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_col</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">op_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span><span class="p">:</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">_op</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">_op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">inp</span><span class="o">.</span><span class="n">op_index</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="n">inp</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">_col</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_python_ops</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">kernel_args</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># To convert an arguments dict, we search for a protobuf with the</span>
                <span class="c1"># name {Op}Args (e.g. BlurArgs, HistogramArgs) in the</span>
                <span class="c1"># args.proto module, and fill that in with keys from the args dict.</span>
                <span class="n">op_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_get_op_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">op_info</span><span class="o">.</span><span class="n">protobuf_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">proto_name</span> <span class="o">=</span> <span class="n">op_info</span><span class="o">.</span><span class="n">protobuf_name</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">kernel_args</span> <span class="o">=</span> <span class="n">python_to_proto</span><span class="p">(</span><span class="n">proto_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">kernel_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If arguments are a protobuf object, serialize it directly</span>
            <span class="n">e</span><span class="o">.</span><span class="n">kernel_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">e</span></div></div>


<div class="viewcode-block" id="register_python_op"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.register_python_op">[docs]</a><span class="k">def</span> <span class="nf">register_python_op</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">stencil</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">unbounded_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">bounded_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">device_type</span><span class="p">:</span> <span class="n">DeviceType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">device_sets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DeviceType</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">proto_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Class or function decorator which registers a new Op and Kernel with the</span>
<span class="sd">    Scanner master.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name</span>
<span class="sd">      Optional name for the Op. By default, it will be inferred as the name of the</span>
<span class="sd">      decorated class/kernel.</span>

<span class="sd">    stencil</span>
<span class="sd">      Specifies the default stencil to use for the Op. If none, indicates</span>
<span class="sd">      that the the Op does not have the ability to stencil. A stencil of</span>
<span class="sd">      [0] should be specified if the Op can stencil but should not by</span>
<span class="sd">      default.</span>

<span class="sd">    unbounded_state</span>
<span class="sd">      If true, indicates that the Op needs to see all previous elements</span>
<span class="sd">      of its input sequences before it can compute a given element. For</span>
<span class="sd">      example, to compute output element at index 100, the Op must have</span>
<span class="sd">      already produced elements 0-99. This option is mutually exclusive</span>
<span class="sd">      with `bounded_state`.</span>

<span class="sd">    bounded_state</span>
<span class="sd">      If true, indicates that the Op needs to see all previous elements</span>
<span class="sd">      of its input sequences before it can compute a given element. For</span>
<span class="sd">      example, to compute output element at index 100, the Op must have</span>
<span class="sd">      already produced elements 0-99. This option is mutually exclusive</span>
<span class="sd">      with `bounded_state`.</span>

<span class="sd">    device_type</span>

<span class="sd">    device_sets</span>

<span class="sd">    batch</span>

<span class="sd">    proto_path</span>
<span class="sd">      Optional path to the proto file that describes the configuration</span>
<span class="sd">      arguments to this Op.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">):</span>
        <span class="n">is_fn</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">,</span> <span class="n">pytypes</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">fn_or_class</span><span class="p">,</span> <span class="n">pytypes</span><span class="o">.</span><span class="n">BuiltinFunctionType</span><span class="p">):</span>
            <span class="n">is_fn</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Infer name from fn_or_class name</span>
            <span class="n">kname</span> <span class="o">=</span> <span class="n">fn_or_class</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kname</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">can_stencil</span> <span class="o">=</span> <span class="n">stencil</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">can_batch</span> <span class="o">=</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="c1"># Get execute function to determine input and output types</span>
        <span class="k">if</span> <span class="n">is_fn</span><span class="p">:</span>
            <span class="n">exec_fn</span> <span class="o">=</span> <span class="n">fn_or_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exec_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">,</span> <span class="s2">&quot;execute&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;Attempted to register Python Op with name </span><span class="si">{:s}</span><span class="s1">, but that &#39;</span>
                     <span class="s1">&#39;provided class has no &quot;execute&quot; method.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kname</span><span class="p">))</span>

        <span class="n">input_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">has_variadic_inputs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">variadic_inputs_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">)</span>

        <span class="n">fn_params</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span>
        <span class="k">if</span> <span class="n">is_fn</span><span class="p">:</span>
            <span class="c1"># If this is a fn kernel, then the first argument should be `config`</span>
            <span class="n">fn_params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">fn_params</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If this is a class kernel, then first argument should be self</span>
            <span class="n">fn_params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">fn_params</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">parse_tuple</span><span class="p">(</span><span class="n">typ</span><span class="p">):</span>
            <span class="n">is_tuple</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">origin_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__origin__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">origin_type</span> <span class="o">==</span> <span class="n">Tuple</span> <span class="ow">or</span> <span class="n">origin_type</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">or</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__tuple_params__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__tuple_params__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="c1"># Python 3.5</span>
                    <span class="n">use_ellipsis</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__tuple_use_ellipsis__</span>
                    <span class="n">tuple_params</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__tuple_params__</span>
                <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__args__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="c1"># Python 3.6+</span>
                    <span class="n">use_ellipsis</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">Ellipsis</span>
                    <span class="n">tuple_params</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">use_ellipsis</span> <span class="k">else</span> <span class="kc">None</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;This should not happen...&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">use_ellipsis</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">is_tuple</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">tuple_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">typ</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">is_tuple</span><span class="p">,</span> <span class="n">use_ellipsis</span><span class="p">,</span> <span class="n">tuple_params</span>

        <span class="k">def</span> <span class="nf">parse_annotation_to_column_type</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">is_input</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">can_batch</span><span class="p">:</span>
                <span class="c1"># If the op can batch, then we expect the types to be</span>
                <span class="c1"># Sequence[T], where T = {bytes, FrameType}</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__origin__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="n">__origin__</span> <span class="o">!=</span> <span class="n">Sequence</span> <span class="ow">and</span>
                     <span class="n">typ</span><span class="o">.</span><span class="n">__origin__</span> <span class="o">!=</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;A batched Op must specify a &quot;Sequence&quot; type &#39;</span>
                         <span class="s1">&#39;annotation for each input and output.&#39;</span><span class="p">))</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">is_input</span> <span class="ow">and</span> <span class="n">can_stencil</span><span class="p">:</span>
                <span class="c1"># If the op can stencil, then we expect the input types to be</span>
                <span class="c1"># Sequence[T], where T = {bytes, FrameType}</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__origin__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="n">__origin__</span> <span class="o">!=</span> <span class="n">Sequence</span> <span class="ow">and</span>
                     <span class="n">typ</span><span class="o">.</span><span class="n">__origin__</span> <span class="o">!=</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;A stenciled Op must specify a &quot;Sequence&quot; type &#39;</span>
                         <span class="s1">&#39;annotation for each input. If the Op both stencils &#39;</span>
                         <span class="s1">&#39;and batches, then it should have the type &#39;</span>
                         <span class="s1">&#39;&quot;Sequence[Sequence[T]], where T = {bytes, FrameType}.&#39;</span>
                         <span class="p">))</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="n">scannertypes</span><span class="o">.</span><span class="n">FrameType</span><span class="p">:</span>
                <span class="n">column_type</span> <span class="o">=</span> <span class="n">ColumnType</span><span class="o">.</span><span class="n">Video</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="nb">bytes</span><span class="p">:</span>
                <span class="n">column_type</span> <span class="o">=</span> <span class="n">ColumnType</span><span class="o">.</span><span class="n">Blob</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For now, all non-FrameType types are equivalent to bytes.</span>
                <span class="n">column_type</span> <span class="o">=</span> <span class="n">ColumnType</span><span class="o">.</span><span class="n">Blob</span>
            <span class="k">return</span> <span class="n">column_type</span><span class="p">,</span> <span class="n">typ</span>

        <span class="c1"># Analyze exec_fn parameters to determine the input types</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">fn_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># We only allow keyword arguments and *args.</span>
            <span class="c1"># There is no support currently for positional or **kwargs</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_ONLY</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;Positional arguments and **kwargs are currently not &#39;</span>
                     <span class="s1">&#39;supported for the &quot;execute&quot; method of kernels&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">:</span>
                <span class="c1"># This means we have variadic inputs</span>
                <span class="n">has_variadic_inputs</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fn_params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;Variadic positional inputs (*args) are not supported &#39;</span>
                         <span class="s1">&#39;when used with other inputs.&#39;</span><span class="p">))</span>
                <span class="c1"># Get tuple type</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span>
                <span class="n">is_tuple</span><span class="p">,</span> <span class="n">use_ellipsis</span><span class="p">,</span> <span class="n">tuple_params</span> <span class="o">=</span> <span class="n">parse_tuple</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
                <span class="n">annotation_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;Variadic positional inputs (*args) must be annotated as &#39;</span>
                    <span class="s1">&#39;&quot;args: Tuple[Type, ...]&quot; or &quot;args: Type&quot;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_tuple</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_ellipsis</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="n">annotation_message</span><span class="p">)</span>
                <span class="n">variadic_inputs_type</span><span class="p">,</span> <span class="n">typ</span> <span class="o">=</span> <span class="n">parse_annotation_to_column_type</span><span class="p">(</span>
                    <span class="n">tuple_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">is_input</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">type_info</span> <span class="o">=</span> <span class="n">scannertypes</span><span class="o">.</span><span class="n">get_type_info</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
                <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">param_name</span><span class="p">,</span> <span class="n">variadic_inputs_type</span><span class="p">,</span> <span class="n">type_info</span><span class="p">))</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;No type annotation specified for input </span><span class="si">{:s}</span><span class="s1">. Must &#39;</span>
                     <span class="s1">&#39;specify an annotation of &quot;bytes&quot; or &quot;FrameType&quot;.&#39;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_name</span><span class="p">))</span>

            <span class="n">typ</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span>
            <span class="n">column_type</span><span class="p">,</span> <span class="n">typ</span> <span class="o">=</span> <span class="n">parse_annotation_to_column_type</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">is_input</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">type_info</span> <span class="o">=</span> <span class="n">scannertypes</span><span class="o">.</span><span class="n">get_type_info</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
            <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">param_name</span><span class="p">,</span> <span class="n">column_type</span><span class="p">,</span> <span class="n">type_info</span><span class="p">))</span>

        <span class="n">output_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Analyze exec_fn return type to determine output types</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="n">sig</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;Return annotation must be specified for &quot;execute&quot; method.&#39;</span><span class="p">))</span>

        <span class="n">return_is_tuple</span><span class="p">,</span> <span class="n">use_ellipsis</span><span class="p">,</span> <span class="n">tuple_params</span> <span class="o">=</span> <span class="n">parse_tuple</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_ellipsis</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;Ellipsis tuples not supported for return type.&#39;</span><span class="p">))</span>

        <span class="c1"># Parse the return types into Scanner column types</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tuple_params</span><span class="p">):</span>
            <span class="n">column_type</span><span class="p">,</span> <span class="n">typ</span> <span class="o">=</span> <span class="n">parse_annotation_to_column_type</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
            <span class="n">type_info</span> <span class="o">=</span> <span class="n">scannertypes</span><span class="o">.</span><span class="n">get_type_info</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
            <span class="n">output_columns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;ret</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">column_type</span><span class="p">,</span> <span class="n">type_info</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">kname</span> <span class="ow">in</span> <span class="n">PYTHON_OP_REGISTRY</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="s1">&#39;Attempted to register Op with name </span><span class="si">{:s}</span><span class="s1"> twice&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kname</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">parse_params</span><span class="p">(</span><span class="n">in_cols</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">type_info</span><span class="p">),</span> <span class="n">cs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_columns</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">can_batch</span> <span class="o">^</span> <span class="n">can_stencil</span><span class="p">:</span>
                    <span class="n">args</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">type_info</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cs</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">can_batch</span> <span class="ow">and</span> <span class="n">can_stencil</span><span class="p">:</span>
                    <span class="n">args</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">type_info</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">c2</span><span class="p">]</span> <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">cs</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">args</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_info</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">args</span>

        <span class="k">def</span> <span class="nf">parse_ret</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">r</span> <span class="k">if</span> <span class="n">return_is_tuple</span> <span class="k">else</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">type_info</span><span class="p">),</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">output_columns</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">can_batch</span><span class="p">:</span>
                    <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                        <span class="n">type_info</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">column</span>
                    <span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">type_info</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>

        <span class="c1"># Wrap exec_fn to destructure input and outputs to proper python inputs</span>
        <span class="k">if</span> <span class="n">is_fn</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_variadic_inputs</span><span class="p">:</span>

                <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">wrapper_exec</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">parse_ret</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">in_cols</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">wrapper_exec</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_params</span><span class="p">(</span><span class="n">in_cols</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">parse_ret</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">))</span>

            <span class="n">wrapped_fn_or_class</span> <span class="o">=</span> <span class="n">wrapper_exec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wrapped_fn_or_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">fn_or_class</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;Kernel&#39;</span><span class="p">,</span> <span class="n">fn_or_class</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">,</span>
                                       <span class="nb">dict</span><span class="p">(</span><span class="n">fn_or_class</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">has_variadic_inputs</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">parse_ret</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">in_cols</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_params</span><span class="p">(</span><span class="n">in_cols</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">parse_ret</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">))</span>
            <span class="n">wrapped_fn_or_class</span><span class="o">.</span><span class="n">execute</span> <span class="o">=</span> <span class="n">execute</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">device_type</span>
        <span class="k">if</span> <span class="n">device_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">device_sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">CPU</span>

        <span class="k">if</span> <span class="n">device_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">device_sets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="s1">&#39;Must only specify one of &quot;device_type&quot; or &quot;device_sets&quot; for python Op.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_fn</span><span class="p">:</span>
            <span class="n">init_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">init_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;config&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s2">&quot;__init__ first argument (after self) must be `config`&quot;</span><span class="p">)</span>
            <span class="n">kernel_params</span> <span class="o">=</span> <span class="n">init_params</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="n">stream_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">,</span> <span class="s2">&quot;new_stream&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kernel_params</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">stream_params</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">PYTHON_OP_REGISTRY</span><span class="p">[</span><span class="n">kname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;input_columns&#39;</span><span class="p">:</span> <span class="n">input_columns</span><span class="p">,</span>
            <span class="s1">&#39;output_columns&#39;</span><span class="p">:</span> <span class="n">output_columns</span><span class="p">,</span>
            <span class="s1">&#39;variadic_inputs&#39;</span><span class="p">:</span> <span class="n">has_variadic_inputs</span><span class="p">,</span>
            <span class="s1">&#39;stencil&#39;</span><span class="p">:</span> <span class="n">stencil</span><span class="p">,</span>
            <span class="s1">&#39;unbounded_state&#39;</span><span class="p">:</span> <span class="n">unbounded_state</span><span class="p">,</span>
            <span class="s1">&#39;bounded_state&#39;</span><span class="p">:</span> <span class="n">bounded_state</span><span class="p">,</span>
            <span class="s1">&#39;kernel&#39;</span><span class="p">:</span> <span class="n">wrapped_fn_or_class</span><span class="p">,</span>
            <span class="s1">&#39;device_type&#39;</span><span class="p">:</span> <span class="n">dtype</span><span class="p">,</span>
            <span class="s1">&#39;device_sets&#39;</span><span class="p">:</span> <span class="n">device_sets</span><span class="p">,</span>
            <span class="s1">&#39;batch&#39;</span><span class="p">:</span> <span class="n">batch</span><span class="p">,</span>
            <span class="s1">&#39;proto_path&#39;</span><span class="p">:</span> <span class="n">proto_path</span><span class="p">,</span>
            <span class="s1">&#39;registration_id&#39;</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span>
            <span class="s1">&#39;kernel_params&#39;</span><span class="p">:</span> <span class="n">kernel_params</span><span class="p">,</span>
            <span class="s1">&#39;stream_params&#39;</span><span class="p">:</span> <span class="n">stream_params</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">fn_or_class</span>

    <span class="k">return</span> <span class="n">dec</span></div>
</pre></div>

      </div>
    </div>
  </div>
</div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Scanner 0.2.22 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/python.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>